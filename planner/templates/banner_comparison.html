{% extends "base.html" %}
{% block extrahead %}
{% endblock %}
{% block content %}
{% load static %}
<style>
	* {
		outline
	}
</style>

<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

<!--
<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
-->

<script type='text/javascript'>
	var json_data = {{ json_data| safe }};
</script>

<div class="container">
	<p>This page allows you to compare your course offerings with those in Banner and
		request changes from the Registrar.
	</p>
</div>

<div id="app">
	<v-app>
		<!-- https://stackoverflow.com/questions/52819619/understand-rows-per-page-items-at-vuetify-data-iterators-data-tables-can-i-->
		<template>
			<template>
				<v-toolbar flat color="white">
					<v-toolbar-title>Course Offerings</v-toolbar-title>
					<v-spacer></v-spacer>
					<v-switch v-model="singleExpand" label="Single expand" class="mt-2"></v-switch>
				</v-toolbar>
			</template>
			<v-data-table 
				:headers="headers" 
				:items="courses"
				:single-expand="singleExpand"
				:expanded.sync="expanded"
				show-expand
				:page.sync="page"
				:items-per-page="itemsPerPage"
				hide-default-footer
				item-key="name" 
				class="elevation-1"
				@page-count="pageCount = $event"
			>
				<template v-slot:items="props">
					<tr @click="props.expanded = !props.expanded" style="cursor: pointer;">
						<td>[[props.item.semester]] </td>
						<td>[[props.item.crn]] </td>
						<td class="text-xs-left">[[props.item.number]]</td>
						<td class="text-xs-left">[[props.item.name]] </td>
						<td class="text-xs-center">
							<v-icon v-if="props.item.hasIChair">check_circle</v-icon>
						</td>
						<td class="text-xs-center">
							<v-icon v-if="props.item.hasBanner">check_circle</v-icon>
						</td>
						<td class="text-xs-center">
							<v-icon class="green--text" v-if="!props.item.needsWork">check_circle</v-icon>
						</td>
				</template>
				<template v-slot:expanded-item="props">
					<td :colspan="headers.length">
						
								<v-container>
									<strong>[[props.item.name]]</strong>
									<v-layout row wrap align-center>
										<v-flex xs3>
											<div v-if="props.item.hasIChair">
												<div>iChair -- meeting time(s):</div>
												<a @click="editMeetingTimes(props.item)">
													<ul>
														<li v-for="meetingTime in props.item.ichair.meeting_times">
															[[meetingTime]]
														</li>
													</ul>
												</a>
											</div>
										</v-flex>

										<v-flex xs1>
											<div style="padding-bottom: 20px" class="btn-group">
												<a class="btn btn-info dropdown-toggle" data-toggle="dropdown" href="#">
													Actions
													<span class="caret"></span>
												</a>
												<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
													<li>
														<a href="{% url 'registrar_schedule' 1 %}" target="_blank"> Accept
															Registrar Version </a>
													</li>
													<li>
														<a href="{% url 'registrar_schedule' 2 %}" target="_blank"> Accept
															iChair Version </a>
													</li>
													<li>
														<a @click="editMeetingTimes(props.item)"> Edit iChair Version</a>
													</li>
												</ul>
											</div> {# btn-group #}
											<template>
												<div class="text-center">
													<v-dialog persistent v-model="dialog" width="800">
														<v-card>
															<v-card-title class="headline grey lighten-2" primary-title>
																[[dialogTitle]]
															</v-card-title>
															<v-card-text>
																<v-container grid-list-md>
																	<v-layout wrap>
																		<v-flex xs4>Day</v-flex>
																		<v-flex xs3>Begin Time (e.g., 13:00)</v-flex>
																		<v-flex xs3>End Time (e.g., 13:50)</v-flex>
																		<v-flex xs2>Delete</v-flex>
																	</v-layout>
																	<div v-for="meetingTimeDetail in editMeetings">
																		<v-layout wrap>
																			<v-flex xs4>

																				<select
																					style="border-style: solid; height: 32px;"
																					id="day_select"
																					v-model="meetingTimeDetail.day">
																					<option value="0">Monday</option>
																					<option value="1">Tuesday</option>
																					<option value="2">Wednesday</option>
																					<option value="3">Thursday</option>
																					<option value="4">Friday</option>
																				</select>
																			</v-flex>
																			<v-flex xs3>
																				<input style="height: 32px; width: 140px;"
																					type="text"
																					v-model="meetingTimeDetail.begin_at">
																			</v-flex>
																			<v-flex xs3>
																				<input style="height: 32px; width: 140px;"
																					type="text"
																					v-model="meetingTimeDetail.end_at">
																			</v-flex>
																			<v-flex xs2>
																				<input type="checkbox"
																					v-model="meetingTimeDetail.delete">
																			</v-flex>
																		</v-layout>
																	</div>
																	<v-layout text-center>
																		<v-flex xs12>
																			<div class="red--text">
																				[[meetingFormErrorMessage]]</div>
																		</v-flex>
																	</v-layout>
																</v-container>
															</v-card-text>
															<v-divider></v-divider>
															<v-card-actions>
																<v-spacer></v-spacer>
																<v-btn color="primary" text @click="cancelMeetingsForm()">
																	Cancel
																</v-btn>
																<v-btn color="primary" text @click="submitMeetingsForm()">
																	Submit
																</v-btn>
															</v-card-actions>
														</v-card>
													</v-dialog>
												</div>
											</template>
										</v-flex>
										<v-flex xs3 offset-xs2>
											<div v-if="props.item.hasIChair">
												<div>iChair -- instructor(s):</div>
												<ul>
													<li v-for="instructor in props.item.ichair.instructors">
														[[instructor]]
													</li>
												</ul>
											</div>
										</v-flex>
										<div style="padding-bottom: 20px" class="btn-group">
											<a class="btn btn-info dropdown-toggle" data-toggle="dropdown" href="#">
												Actions
												<span class="caret"></span>
											</a>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
												<li>
													<a href="{% url 'registrar_schedule' 1 %}" target="_blank"> Accept
														Registrar Version</a>
												</li>
												<li>
													<a href="{% url 'registrar_schedule' 2 %}" target="_blank"> Accept
														iChair Version </a>
												</li>
												<li>
													<a href="{% url 'registrar_schedule' 2 %}" target="_blank"> Edit iChair
														Version</a>
												</li>
											</ul>
										</div> {# btn-group #}
									</v-layout>
									<v-layout row wrap>
										<v-flex xs3>
											<div v-if="props.item.hasBanner">
												<div>Registrar -- meeting time(s):</div>
												<ul>
													<li v-for="meetingTime in props.item.banner.meeting_times">
														[[meetingTime]]
													</li>
												</ul>
											</div>
										</v-flex>
										<v-flex xs3></v-flex>
										<v-flex xs3>
											<div v-if="props.item.hasBanner">
												<div>Registrar -- instructor(s):</div>
												<ul>
													<li v-for="instructor in props.item.banner.instructors">
														[[instructor]]
													</li>
												</ul>
											</div>
										</v-flex>
										<v-flex xs3></v-flex>
									</v-layout>
								</v-container>
							
					</td>
				</template>
			</v-data-table>
			<div class="text-center pt-2">
				<v-pagination v-model="page" :length="pageCount"></v-pagination>
				<v-btn v-if="!showAllCourses" color="primary" @click.stop="showAll()">Show All</v-btn>
				<!-- example: https://www.tremblant.ca/things-to-do/activities#filters=seasons:Summer -->
				<v-btn v-else color="primary" @click.stop="showFewer()">Show Fewer</v-btn>
				<!--
				<v-text-field
					:value="itemsPerPage"
					label="Items per page"
					type="number"
					min="-1"
					max="15"
					@input="itemsPerPage = parseInt($event, 10)"
				></v-text-field>
				-->
			</div>
		</template>
	</v-app>
</div>

<script>
	var app = new Vue({
		delimiters: ['[[', ']]'],
		el: '#app',
		vuetify: new Vuetify(),
		data() {
			return {
				expanded: [],
        		singleExpand: false,
				message: 'Hello Vue!',
				search: '',
				json_data: json_data,
				page: 1,
				pageCount: 0,
				itemsPerPage: 2,
				showAllCourses: false,
				buttonRipple: false,
				headers: [
					{ text: 'Semester - Fraction', value: 'semester' },
					{ text: 'CRN', value: 'crn' },
					{
						text: 'Number',
						align: 'left',
						sortable: true,
						value: 'number'
					},
					{ text: 'Name', value: 'name', align: 'left' },
					{ text: 'In iChair', value: 'ichair', align: 'center' },
					{ text: 'In Banner', value: 'banner', align: 'center' },
					{ text: 'Done?', value: 'linked', align: 'center' }
				],
				courses: [],
				dialog: false, // true when the dialog is being displayed
				dialogTitle: '',
				editMeetings: [], // used to store the data in the class schedule form
				editCourseOfferingData: {}, // used to store some data that can be used upon submitting the class schedule form
				initialMeetingData: [], // used to hold on to the initial class schedule (before editing)
				meetingFormErrorMessage: '',// used to display errors in the class scheduling form
				pagination: {
					rowsPerPage: 20
				}
			};
		},
		methods: {

			showAll() {
				this.itemsPerPage = this.courses.length;
				this.page = 1;
				this.showAllCourses = true;
			},
			showFewer() {
				this.itemsPerPage = 3;
				this.showAllCourses = false;
			},
			editMeetingTimes(courseInfo) {
				this.editCourseOfferingData = {
					'courseOfferingId': courseInfo.ichair.course_offering_id,
					'ichairObject': courseInfo.ichair
				}
				this.dialogTitle = courseInfo.number + ': ' + courseInfo.name;
				let meetingDetails = courseInfo.ichair.meeting_times_detail;
				this.dialog = true;
				//trick to clone the object: https://www.codementor.io/junedlanja/copy-javascript-object-right-way-ohppc777d
				this.editMeetings = JSON.parse(JSON.stringify(meetingDetails));
				this.editMeetings.forEach(meeting => {
					meeting.delete = false;
				});

				this.initialMeetingData = meetingDetails;
				this.addMeetingTime();
				this.addMeetingTime();
			},

			addMeetingTime() {
				this.editMeetings.push(
					{
						delete: false,
						day: 0,
						begin_at: "",
						end_at: "",
						id: null
					}
				)
			},

			cancelMeetingsForm() {
				this.dialog = false;
				this.editMeetings = [];
				this.meetingFormErrorMessage = '';
				this.editCourseOfferingData = {};
			},

			submitMeetingsForm() {
				let meetingsToDelete = [];//list of ids
				let meetingsToUpdate = [];//list of objects
				let meetingsToCreate = [];//list of objects
				let meetingsToLeave = [];//list of objects
				this.meetingFormErrorMessage = '';
				let formOK = true;
				this.editMeetings.forEach(meeting => {
					if ((meeting.id !== null) && (meeting.delete === true)) {
						meetingsToDelete.push(meeting.id);
					} else if (meeting.delete === false) {
						// check if need to make updates....
						if ((meeting.begin_at !== '') || (meeting.end_at !== '')) {
							if (meeting.id === null) {
								let checkTime = this.checkTimes(meeting.begin_at, meeting.end_at);
								if (checkTime.timesOK) {
									meetingsToCreate.push({
										day: parseInt(meeting.day),
										begin_at: meeting.begin_at,
										end_at: meeting.end_at
									})
								} else {
									this.meetingFormErrorMessage = checkTime.errorMessage;
									formOK = false;
								}
							} else {
								let checkTime = this.checkTimes(meeting.begin_at, meeting.end_at);
								// now check if anything is different....
								let timesIdentical = true;
								if (!checkTime.timesOK) {
									this.meetingFormErrorMessage = checkTime.errorMessage;
									formOK = false;
								} else {
									// now check if anything has been changed in the form;
									// find the corresponding element in this.initialMeetingData and look for differences....
									let foundMeeting = false;
									let matchingMeeting = null;
									this.initialMeetingData.forEach(initialData => {
										if (initialData.id === meeting.id) {
											foundMeeting = true;
											matchingMeeting = initialData;
										}
									});

									if (foundMeeting) {
										// meeting.day could come from the form, so it might be a string....
										timesIdentical = (matchingMeeting.day === parseInt(meeting.day)) && (matchingMeeting.begin_at === meeting.begin_at) && (matchingMeeting.end_at === meeting.end_at);
									} else {
										console.log('something is wrong! cannot find the id for the update....')
									}

									if (!timesIdentical) {
										meetingsToUpdate.push({
											id: meeting.id,
											day: parseInt(meeting.day),
											begin_at: meeting.begin_at,
											end_at: meeting.end_at
										})
									} else {
										meetingsToLeave.push({
											id: meeting.id,
											day: parseInt(meeting.day),
											begin_at: meeting.begin_at,
											end_at: meeting.end_at
										})
									}
								}
							}

						}
					}
				});

				let meetingSummary = [];
				meetingsToCreate.forEach(meeting => meetingSummary.push(meeting));
				meetingsToUpdate.forEach(meeting => meetingSummary.push(meeting));
				meetingsToLeave.forEach(meeting => meetingSummary.push(meeting));

				if (formOK) {
					// everything else is OK, so check if the various times conflict with each other
					let checkTimeOverlaps = this.checkTimeConflicts(meetingSummary);
					if (!checkTimeOverlaps.timesOK) {
						this.meetingFormErrorMessage = checkTimeOverlaps.errorMessage;
						formOK = false;
					}
				}

				let numChanges = meetingsToCreate.length + meetingsToUpdate.length + meetingsToDelete.length;

				if (formOK && numChanges > 0) {
					// now post the data...
					var _this = this;
					let data_for_post = {
						'courseOfferingId': this.editCourseOfferingData.courseOfferingId,
						'delete': meetingsToDelete,
						'update': meetingsToUpdate,
						'create': meetingsToCreate
					}
					// https://stackoverflow.com/questions/53714037/decoding-django-post-request-body
					// https://stackoverflow.com/questions/1208067/wheres-my-json-data-in-my-incoming-django-request
					$.ajax({                       // initialize an AJAX request
						type: "POST",
						url: "/planner/ajax/update-class-schedule/",               
						dataType: 'json',
						data: JSON.stringify(data_for_post),
						success: function (jsonResponse) {
							_this.editCourseOfferingData.ichairObject.meeting_times_detail = jsonResponse.meeting_times_detail;
							_this.editCourseOfferingData.ichairObject.meeting_times = jsonResponse.meeting_times;
							_this.cancelMeetingsForm();
						},
						error: function (jqXHR, exception) {
							// https://stackoverflow.com/questions/6792878/jquery-ajax-error-function
							console.log(jqXHR);
							_this.meetingFormErrorMessage = 'Sorry, there appears to have been an error.'
						}
					});
				}


			},

			checkTimes(beginTime, endTime) {
				let beginValid = this.timeStringValid(beginTime);
				let endValid = this.timeStringValid(endTime);

				if (!(beginValid && endValid)) {
					return {
						errorMessage: 'Beginning and ending times must be in the correct format.',
						timesOK: false
					}
				} else {
					if (!this.timeSeqOK(beginTime, endTime)) {
						return {
							errorMessage: 'Ending time must be after beginning time.',
							timesOK: false
						}
					}
				}
				return {
					errorMessage: '',
					timesOK: true
				}
			},

			checkTimeConflicts(meetingSummary) {
				daySchedules = { 0: [], 1: [], 2: [], 3: [], 4: [] };
				let timesOK = true;
				meetingSummary.forEach(meeting => {
					let begin = this.convertTimeStringToInt(meeting.begin_at);
					let end = this.convertTimeStringToInt(meeting.end_at);
					daySchedules[meeting.day].forEach(meetingTime => {
						let existingBegin = meetingTime.begin;
						let existingEnd = meetingTime.end;
						if (((begin < existingEnd) && (begin > existingBegin)) || ((end < existingEnd) && (end > existingBegin)) || ((begin <= existingBegin) && (end >= existingEnd))) {
							timesOK = false;
						}
					});
					if (timesOK) {
						daySchedules[meeting.day].push(
							{
								begin: begin,
								end: end
							}
						)
					}
				});
				return {
					timesOK: timesOK,
					errorMessage: timesOK ? '' : 'Time blocks for a given day within a course offering cannot overlap.'
				}
			},

			timeStringValid(timeString) {
				return /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])?$/.test(timeString);
			},

			timeSeqOK(beginTimeString, endTimeString) {
				return this.convertTimeStringToInt(endTimeString) > this.convertTimeStringToInt(beginTimeString);
			},

			convertTimeStringToInt(timeString) {
				let multiplicativeFactors = [10000, 100, 1];
				let timeSum = 0;
				let timeSplit = timeString.split(':');
				// https://www.w3schools.com/jsref/jsref_parseint.asp
				for (var i = 0; i < timeSplit.length; i++) {
					timeSum += multiplicativeFactors[i] * parseInt(timeSplit[i]);
				}
				return timeSum;
			},

			greet: function (name) {
				//console.log('Hello from ' + name + '!');
			},
			// https://stackoverflow.com/questions/44309464/hide-table-column-with-vue-js
			showColumn(col) {
				return this.headers.find(h => h.value === col).selected
			},
			toggle(col) {
				let tempSelected = this.headers.find(h => h.value === col).selected;
				this.headers.find(h => h.value === col).selected = !tempSelected;
			},
		},
		// https://stackoverflow.com/questions/44309464/hide-table-column-with-vue-js
		computed: {
			filteredHeaders() {
				return this.headers.filter(h => h.selected)
			},
			checkboxVal(col) {
				return this.headers.find(h => h.value === col).selected;
			}
		},
		mounted: function () {
			var _this = this;
			$.ajax({                       // initialize an AJAX request
				type: "GET",
				url: "/planner/ajax/fetch-banner-comparison-data/",                    // set the url of the request
				dataType: 'json',
				data: {
					'departmentId': json_data.departmentId,       // add the faculty id to the GET parameters
					'yearId': json_data.yearId
				},
				success: function (incomingData) {
					// https://stackoverflow.com/questions/3590685/accessing-this-from-within-an-objects-inline-function
					incomingData.course_data.forEach(course => {
						_this.courses.push({
							semester: course.semester,
							number: course.course,
							name: course.course_title,
							crn: course.crn,
							ichair: course.ichair,
							banner: course.banner,
							hasIChair: course.has_ichair,
							hasBanner: course.has_banner,
							linked: course.linked,
							needsWork: course.needs_work
						});
					});

				}
			});
		}
	});
</script>







<!-- https://stackoverflow.com/questions/49421170/change-font-size-of-v-radio-vuetify?rq=1 -->
<style scoped>
	.v-label {
		font-size: 14px;
		margin-left: 2px;
	}

	.v-input input {
		height: 32px;
		margin-bottom: 4px;
	}
</style>


<script>
	//window.addEventListener("resize",function(){alertMessage();},true);
	$(window).load(function () {
		$("#nav-bannercomparison").addClass("current");
		$('.page-name').find('h1').replaceWith('<h1>Banner Comparison</h1><h2>{{department}}, {{academic_year_string}}</h2>');
		$(".page-name").stop().animate({ opacity: 1, 'margin-left': '5%' }, 700);
	});
</script>


{% endblock %}